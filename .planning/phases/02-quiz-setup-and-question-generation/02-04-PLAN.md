---
phase: 02-quiz-setup-and-question-generation
plan: 04
type: execute
wave: 3
depends_on:
  - 02-02
  - 02-03
files_modified:
  - src/components/quiz/QuestionDisplay.tsx
  - src/components/quiz/ProgressIndicator.tsx
  - src/components/quiz/AnswerInput.tsx
  - src/components/quiz/TopicBadge.tsx
  - src/pages/QuizSession.tsx
  - src/App.tsx
autonomous: false
requirements:
  - QUIZ-01
  - QUIZ-02
  - QUIZ-03
  - QUIZ-05
  - QUIZ-06

must_haves:
  truths:
    - "Navigating to /quiz/:sessionId fetches the session from Supabase and renders the quiz UI"
    - "Quiz session page shows the current question with title and body rendered as markdown (QUIZ-01)"
    - "Quiz session page shows which topics are covered in the current session in the header (QUIZ-06)"
    - "Quiz session page shows a progress indicator displaying 'Question X of Y' (QUIZ-05)"
    - "Coding questions render a Monaco code editor as the answer input (QUIZ-02)"
    - "Theoretical questions render a textarea as the answer input (QUIZ-02)"
    - "A Skip button is visible and clicking it advances to the next question without requiring an answer (QUIZ-03)"
    - "After skipping, the progress indicator updates (e.g., Question 2 of 10 → Question 3 of 10)"
    - "When question generation fails after retries, the user sees an error message with a Regenerate button"
    - "Human verifies the full quiz flow in browser: setup → session page → question renders → skip works → progress updates"
  artifacts:
    - path: "src/components/quiz/QuestionDisplay.tsx"
      provides: "Renders question title and markdown body, shows topic badge (QUIZ-01, QUIZ-06)"
      exports: ["QuestionDisplay"]
    - path: "src/components/quiz/ProgressIndicator.tsx"
      provides: "Displays 'Question X of Y' text and a progress bar (QUIZ-05)"
      exports: ["ProgressIndicator"]
    - path: "src/components/quiz/AnswerInput.tsx"
      provides: "Conditional Monaco editor (coding) or textarea (theoretical) with Submit and Skip buttons (QUIZ-02, QUIZ-03)"
      exports: ["AnswerInput"]
    - path: "src/components/quiz/TopicBadge.tsx"
      provides: "Pill badge component for rendering topic names in the session header (QUIZ-06)"
      exports: ["TopicBadge"]
    - path: "src/pages/QuizSession.tsx"
      provides: "Quiz session page: fetches session, generates question on mount and after skip/submit, composes all components"
      exports: ["default QuizSessionPage"]
    - path: "src/App.tsx"
      provides: "Route /quiz/:sessionId wired to QuizSessionPage wrapped in QuizProvider"
  key_links:
    - from: "src/pages/QuizSession.tsx"
      to: "src/lib/quiz/sessions.ts"
      via: "getQuizSession(sessionId) called on mount to restore session config"
      pattern: "getQuizSession"
    - from: "src/pages/QuizSession.tsx"
      to: "src/hooks/useQuestionGeneration.ts"
      via: "generate() called with session config params after session loads and when advancing questions"
      pattern: "generate"
    - from: "src/pages/QuizSession.tsx"
      to: "src/context/QuizContext.tsx"
      via: "initializeSession(), skipQuestion(), moveToNextQuestion(), getProgress() consumed via useQuizSession()"
      pattern: "useQuizSession"
    - from: "src/components/quiz/AnswerInput.tsx"
      to: "@monaco-editor/react"
      via: "Lazy-loaded Editor component rendered only when question.type === 'coding'"
      pattern: "Monaco|Editor"
    - from: "src/components/quiz/QuestionDisplay.tsx"
      to: "markdown-it"
      via: "question.body rendered via md.render() to produce sanitized HTML"
      pattern: "markdown-it|md\\.render"
---

<objective>
Build the quiz session page and all its UI components: question display with markdown rendering, progress indicator, answer input (Monaco editor for coding / textarea for theoretical), skip button, and topic badge. Wire the full flow together: fetch session from Supabase → generate first question → display → skip or submit → generate next → repeat.

Purpose: QUIZ-01, QUIZ-02, QUIZ-03, QUIZ-05, QUIZ-06 all require a working session UI. This plan closes Phase 2 — after this plan, a user can go from the setup form through a complete question flow. A human verification checkpoint confirms the full end-to-end experience in a real browser before Phase 2 is declared complete.

Output:
- src/components/quiz/QuestionDisplay.tsx: markdown-rendered question with topic badge
- src/components/quiz/ProgressIndicator.tsx: "Question X of Y" with progress bar
- src/components/quiz/AnswerInput.tsx: Monaco editor (coding) or textarea (theoretical) with Skip and Submit
- src/components/quiz/TopicBadge.tsx: pill badge for session topics
- src/pages/QuizSession.tsx: full session page composing all components
- src/App.tsx: route /quiz/:sessionId updated to render QuizSessionPage
</objective>

<execution_context>
@/Users/danielvillamizar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielvillamizar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-quiz-setup-and-question-generation/02-RESEARCH.md
@.planning/phases/02-quiz-setup-and-question-generation/02-02-SUMMARY.md
@.planning/phases/02-quiz-setup-and-question-generation/02-03-SUMMARY.md

Phase 2 dependencies (from 02-02 and 02-03):
- getQuizSession() from src/lib/quiz/sessions.ts — fetches QuizSessionRow from Supabase
- useQuizSession() from src/context/QuizContext.tsx — session state (initializeSession, skipQuestion, moveToNextQuestion, getProgress, isSessionComplete)
- useQuestionGeneration() from src/hooks/useQuestionGeneration.ts — generates questions with loading/error state
- QuizProvider already wired in App.tsx wrapping /quiz/:sessionId route

Established patterns:
- Dashboard layout: min-h-screen bg-gray-50 flex flex-col
- useAuth() provides user.id
- Lazy loading Monaco: import { lazy, Suspense } from 'react'; lazy(() => import('@monaco-editor/react'))
- Tailwind CSS via @tailwindcss/vite (no config file)
- markdown-it installed in 02-01; use md.render() for sanitized HTML output
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build quiz display components (QuestionDisplay, ProgressIndicator, TopicBadge)</name>
  <files>
    src/components/quiz/QuestionDisplay.tsx
    src/components/quiz/ProgressIndicator.tsx
    src/components/quiz/TopicBadge.tsx
  </files>
  <action>
    **src/components/quiz/TopicBadge.tsx** — Pill badge for topic names:

    ```tsx
    // src/components/quiz/TopicBadge.tsx
    // Displays a single topic as a small pill badge. Used in session header (QUIZ-06).
    interface TopicBadgeProps {
      topic: string
    }

    export function TopicBadge({ topic }: TopicBadgeProps) {
      return (
        <span className="inline-flex items-center rounded-full bg-blue-50 border border-blue-200 px-2.5 py-0.5 text-xs font-medium text-blue-700">
          {topic}
        </span>
      )
    }
    ```

    **src/components/quiz/ProgressIndicator.tsx** — Question X of Y with progress bar (QUIZ-05):

    ```tsx
    // src/components/quiz/ProgressIndicator.tsx
    // Displays progress through the current quiz session.
    // Shows "Question X of Y" text and a visual progress bar.
    interface ProgressIndicatorProps {
      current: number   // 1-based current question number
      total: number     // Total questions in session
      percent: number   // 0-100 completion percentage
    }

    export function ProgressIndicator({ current, total, percent }: ProgressIndicatorProps) {
      return (
        <div className="space-y-1.5">
          <div className="flex items-center justify-between">
            <span className="text-sm font-medium text-gray-700">
              Question {current} of {total}
            </span>
            <span className="text-xs text-gray-500">{percent}% complete</span>
          </div>
          <div className="h-1.5 w-full overflow-hidden rounded-full bg-gray-200">
            <div
              className="h-full rounded-full bg-blue-600 transition-all duration-300"
              style={{ width: `${percent}%` }}
              role="progressbar"
              aria-valuenow={percent}
              aria-valuemin={0}
              aria-valuemax={100}
              aria-label={`Question ${current} of ${total}`}
            />
          </div>
        </div>
      )
    }
    ```

    **src/components/quiz/QuestionDisplay.tsx** — Markdown question body (QUIZ-01):

    ```tsx
    // src/components/quiz/QuestionDisplay.tsx
    // Renders a generated question with title and markdown-rendered body.
    // Uses markdown-it for secure rendering (sanitizes HTML by default).
    // Shows topic badge and question type indicator alongside the content (QUIZ-06 partial).
    import { useMemo } from 'react'
    import MarkdownIt from 'markdown-it'
    import type { GeneratedQuestion } from '../../types/quiz'

    const md = new MarkdownIt({
      html: false,        // Never allow raw HTML from LLM output — XSS prevention
      linkify: true,
      typographer: true
    })

    interface QuestionDisplayProps {
      question: GeneratedQuestion
    }

    export function QuestionDisplay({ question }: QuestionDisplayProps) {
      const renderedBody = useMemo(
        () => md.render(question.body),
        [question.body]
      )

      const typeLabel = question.type === 'coding' ? 'Coding Problem' : 'Theoretical'
      const typeBadgeClass = question.type === 'coding'
        ? 'bg-purple-50 border-purple-200 text-purple-700'
        : 'bg-green-50 border-green-200 text-green-700'

      return (
        <div className="space-y-4">
          {/* Question metadata row */}
          <div className="flex flex-wrap items-center gap-2">
            <span className={`inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-medium ${typeBadgeClass}`}>
              {typeLabel}
            </span>
            <span className="inline-flex items-center rounded-full bg-gray-100 border border-gray-200 px-2.5 py-0.5 text-xs font-medium text-gray-600">
              {question.topic}
            </span>
            <span className="inline-flex items-center rounded-full bg-amber-50 border border-amber-200 px-2.5 py-0.5 text-xs font-medium text-amber-700 capitalize">
              {question.difficulty}
            </span>
          </div>

          {/* Question title */}
          <h2 className="text-lg font-semibold text-gray-900 leading-snug">
            {question.title}
          </h2>

          {/* Question body — markdown rendered */}
          <div
            className="prose prose-sm max-w-none text-gray-700 prose-code:bg-gray-100 prose-code:rounded prose-code:px-1 prose-pre:bg-gray-900 prose-pre:text-gray-100"
            dangerouslySetInnerHTML={{ __html: renderedBody }}
          />

          {/* Expected format hint */}
          {question.expectedFormat && (
            <p className="text-xs text-gray-500 italic">
              Expected format: {question.expectedFormat}
            </p>
          )}
        </div>
      )
    }
    ```

    NOTE on dangerouslySetInnerHTML: markdown-it with `html: false` sanitizes the LLM output by escaping raw HTML tags before rendering. This is safe as long as the `html` option remains false. Add a comment in the code confirming this.
  </action>
  <verify>
    - Run: `npx tsc --noEmit` — all three components must compile cleanly
    - Inspect QuestionDisplay: confirm `html: false` is set on the MarkdownIt instance (not `html: true`)
    - Inspect ProgressIndicator: confirm aria-valuenow, aria-valuemin, aria-valuemax are set for accessibility
    - Confirm TopicBadge renders a `<span>` not a `<div>` (inline-flex pattern)
  </verify>
  <done>
    - src/components/quiz/TopicBadge.tsx renders topic name as a pill badge
    - src/components/quiz/ProgressIndicator.tsx renders "Question X of Y" text + progress bar with ARIA attributes
    - src/components/quiz/QuestionDisplay.tsx renders title, type badge, topic badge, difficulty badge, markdown body, expected format hint
    - markdown-it configured with html: false (XSS safe)
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Build AnswerInput component and QuizSession page</name>
  <files>
    src/components/quiz/AnswerInput.tsx
    src/pages/QuizSession.tsx
    src/App.tsx
  </files>
  <action>
    **src/components/quiz/AnswerInput.tsx** — Monaco editor or textarea based on question type (QUIZ-02, QUIZ-03):

    ```tsx
    // src/components/quiz/AnswerInput.tsx
    // Conditional answer input: Monaco Editor for coding questions, textarea for theoretical.
    // Monaco is lazy-loaded to avoid bloating the initial bundle (~1.5MB).
    // Shows both Submit Answer and Skip buttons.
    import { lazy, Suspense, useRef, useState } from 'react'
    import type { GeneratedQuestion } from '../../types/quiz'

    // Lazy load Monaco to keep initial bundle small
    const MonacoEditor = lazy(() =>
      import('@monaco-editor/react').then(m => ({ default: m.default }))
    )

    // Map question topic to Monaco language identifier
    function inferLanguage(question: GeneratedQuestion): string {
      const topic = question.topic.toLowerCase()
      if (topic.includes('python')) return 'python'
      if (topic.includes('typescript')) return 'typescript'
      if (topic.includes('javascript') || topic.includes('react') || topic.includes('node')) return 'javascript'
      if (topic.includes('java')) return 'java'
      if (topic.includes('go')) return 'go'
      if (topic.includes('rust')) return 'rust'
      if (topic.includes('dart') || topic.includes('flutter')) return 'dart'
      if (topic.includes('sql')) return 'sql'
      return 'plaintext'
    }

    interface AnswerInputProps {
      question: GeneratedQuestion
      onSubmit: (answer: string) => void
      onSkip: () => void
      isSubmitting?: boolean
    }

    export function AnswerInput({ question, onSubmit, onSkip, isSubmitting = false }: AnswerInputProps) {
      const editorRef = useRef<{ getValue: () => string } | null>(null)
      const [textAnswer, setTextAnswer] = useState('')

      const handleSubmit = () => {
        if (question.type === 'coding') {
          const code = editorRef.current?.getValue() ?? ''
          onSubmit(code)
        } else {
          onSubmit(textAnswer)
        }
      }

      return (
        <div className="space-y-4">
          {/* Answer input area */}
          {question.type === 'coding' ? (
            <div className="rounded-md overflow-hidden border border-gray-300">
              <Suspense fallback={
                <div className="h-64 flex items-center justify-center bg-gray-900 text-gray-400 text-sm">
                  Loading editor...
                </div>
              }>
                <MonacoEditor
                  height="320px"
                  language={inferLanguage(question)}
                  defaultValue={`// Write your solution here\n`}
                  onMount={(editor) => {
                    editorRef.current = editor
                  }}
                  theme="vs-dark"
                  options={{
                    minimap: { enabled: false },
                    fontSize: 14,
                    wordWrap: 'on',
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    automaticLayout: true
                  }}
                />
              </Suspense>
            </div>
          ) : (
            <textarea
              value={textAnswer}
              onChange={e => setTextAnswer(e.target.value)}
              placeholder="Type your answer here... (Ctrl+Enter to submit)"
              rows={8}
              onKeyDown={e => {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                  e.preventDefault()
                  handleSubmit()
                }
              }}
              className="w-full rounded-md border border-gray-300 px-4 py-3 text-sm text-gray-900 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-y"
            />
          )}

          {/* Action buttons */}
          <div className="flex items-center gap-3">
            <button
              onClick={handleSubmit}
              disabled={isSubmitting}
              className="flex-1 rounded-md bg-blue-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              {isSubmitting ? 'Submitting...' : 'Submit Answer'}
            </button>
            <button
              onClick={onSkip}
              disabled={isSubmitting}
              className="rounded-md border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
            >
              Skip
            </button>
          </div>

          {/* Keyboard hint for theoretical questions */}
          {question.type === 'theoretical' && (
            <p className="text-xs text-gray-400 text-right">Ctrl+Enter to submit</p>
          )}
        </div>
      )
    }
    ```

    **src/pages/QuizSession.tsx** — Full session page:

    ```tsx
    // src/pages/QuizSession.tsx
    // Quiz session page. Orchestrates: session fetch → question generation → display → skip/submit → loop.
    // Uses QuizContext (useQuizSession) for local session state and useQuestionGeneration for LLM calls.
    import { useEffect, useState } from 'react'
    import { useParams, useNavigate } from 'react-router-dom'
    import { useAuth } from '../context/AuthContext'
    import { useQuizSession } from '../context/QuizContext'
    import { useQuestionGeneration } from '../hooks/useQuestionGeneration'
    import { getQuizSession } from '../lib/quiz/sessions'
    import { QuestionDisplay } from '../components/quiz/QuestionDisplay'
    import { ProgressIndicator } from '../components/quiz/ProgressIndicator'
    import { AnswerInput } from '../components/quiz/AnswerInput'
    import { TopicBadge } from '../components/quiz/TopicBadge'
    import type { QuizSessionRow } from '../types/database'

    export default function QuizSessionPage() {
      const { sessionId } = useParams<{ sessionId: string }>()
      const { user } = useAuth()
      const navigate = useNavigate()
      const {
        session,
        initializeSession,
        addQuestion,
        skipQuestion,
        moveToNextQuestion,
        getProgress,
        isSessionComplete
      } = useQuizSession()

      const { question, isLoading, error, generate, reset } = useQuestionGeneration({
        sessionId: sessionId ?? ''
      })

      const [sessionRow, setSessionRow] = useState<QuizSessionRow | null>(null)
      const [fetchError, setFetchError] = useState<string | null>(null)

      // Step 1: Fetch session from Supabase on mount
      useEffect(() => {
        if (!sessionId) return

        getQuizSession(sessionId)
          .then(row => {
            if (!row) {
              setFetchError('Quiz session not found.')
              return
            }
            setSessionRow(row)
            initializeSession(row)
          })
          .catch(err => {
            setFetchError(err instanceof Error ? err.message : 'Failed to load session.')
          })
      }, [sessionId, initializeSession])

      // Step 2: Generate first question when session is ready, then each subsequent question
      useEffect(() => {
        if (!session || !sessionRow) return
        if (isSessionComplete()) {
          navigate('/dashboard') // Session complete — Phase 3 will add a summary screen
          return
        }

        const params = {
          topics: session.config.topics,
          difficulty: session.config.difficulty,
          types: session.config.questionTypes as ('coding' | 'theoretical')[],
          sessionId: session.sessionId,
          questionIndex: session.currentQuestionIndex
        }

        reset()
        generate(params, session.currentQuestionIndex).then(generated => {
          if (generated) addQuestion(generated)
        })
      // eslint-disable-next-line react-hooks/exhaustive-deps
      }, [session?.currentQuestionIndex, sessionRow])

      const handleSkip = () => {
        skipQuestion()
      }

      const handleSubmit = (answer: string) => {
        // In Phase 2, submit just advances. Phase 3 adds evaluation.
        console.log('Answer submitted (evaluation in Phase 3):', answer.substring(0, 100))
        moveToNextQuestion()
      }

      const progress = getProgress()

      // Loading state
      if (!sessionRow && !fetchError) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <p className="text-gray-500">Loading session...</p>
          </div>
        )
      }

      // Session fetch error
      if (fetchError) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center space-y-3">
              <p className="text-red-600 font-medium">{fetchError}</p>
              <button
                onClick={() => navigate('/quiz/setup')}
                className="text-sm text-blue-600 underline"
              >
                Start a new quiz
              </button>
            </div>
          </div>
        )
      }

      return (
        <div className="min-h-screen bg-gray-50">
          {/* Session header: topic badges + progress indicator */}
          <header className="sticky top-0 z-10 border-b border-gray-200 bg-white px-4 py-3 shadow-sm">
            <div className="mx-auto max-w-3xl space-y-2">
              {/* QUIZ-06: Topics covered in session */}
              <div className="flex flex-wrap items-center gap-1.5">
                <span className="text-xs font-medium text-gray-500 mr-1">Topics:</span>
                {session?.config.topics.map(topic => (
                  <TopicBadge key={topic} topic={topic} />
                ))}
              </div>
              {/* QUIZ-05: Progress indicator */}
              <ProgressIndicator
                current={progress.current}
                total={progress.total}
                percent={progress.percent}
              />
            </div>
          </header>

          {/* Main question area */}
          <main className="mx-auto max-w-3xl px-4 py-8 space-y-8">
            {/* Question generation loading state */}
            {isLoading && (
              <div className="rounded-lg bg-white border border-gray-200 shadow-sm p-8">
                <div className="flex flex-col items-center gap-3 text-gray-400">
                  <div className="h-6 w-6 animate-spin rounded-full border-2 border-blue-600 border-t-transparent" />
                  <p className="text-sm">Generating question...</p>
                </div>
              </div>
            )}

            {/* Question generation error state */}
            {error && !isLoading && (
              <div className="rounded-lg bg-red-50 border border-red-200 p-6 space-y-3">
                <p className="text-sm text-red-700 font-medium">Failed to generate question</p>
                <p className="text-xs text-red-600">{error}</p>
                <div className="flex gap-3">
                  <button
                    onClick={() => {
                      if (!session) return
                      const params = {
                        topics: session.config.topics,
                        difficulty: session.config.difficulty,
                        types: session.config.questionTypes as ('coding' | 'theoretical')[],
                        sessionId: session.sessionId,
                        questionIndex: session.currentQuestionIndex
                      }
                      generate(params, session.currentQuestionIndex).then(generated => {
                        if (generated) addQuestion(generated)
                      })
                    }}
                    className="rounded-md bg-red-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-red-500"
                  >
                    Regenerate
                  </button>
                  <button
                    onClick={handleSkip}
                    className="rounded-md border border-red-300 px-3 py-1.5 text-xs font-medium text-red-700 hover:bg-red-50"
                  >
                    Skip this question
                  </button>
                </div>
              </div>
            )}

            {/* Question display and answer input */}
            {question && !isLoading && (
              <>
                {/* QUIZ-01: Question display with clear formatting */}
                <div className="rounded-lg bg-white border border-gray-200 shadow-sm p-6">
                  <QuestionDisplay question={question} />
                </div>

                {/* QUIZ-02 + QUIZ-03: Answer input with Skip button */}
                <div className="rounded-lg bg-white border border-gray-200 shadow-sm p-6">
                  <h3 className="text-sm font-semibold text-gray-700 mb-4">Your Answer</h3>
                  <AnswerInput
                    question={question}
                    onSubmit={handleSubmit}
                    onSkip={handleSkip}
                  />
                </div>
              </>
            )}
          </main>
        </div>
      )
    }
    ```

    **Update src/App.tsx** — Replace placeholder with real QuizSessionPage:

    Find the `/quiz/:sessionId` route and replace the placeholder `<div>` with:
    ```tsx
    import QuizSessionPage from './pages/QuizSession'
    // Inside the /quiz/:sessionId route, replace the placeholder div with:
    <QuizProvider>
      <QuizSessionPage />
    </QuizProvider>
    ```
    (QuizProvider is already imported from context/QuizContext from Plan 02-03's App.tsx update)
  </action>
  <verify>
    - Run: `npm run build` — must succeed with zero TypeScript errors and no import errors
    - Run: `npm run dev`
    - Navigate to /quiz/setup → fill out form → click Start Quiz
    - Verify /quiz/:sessionId loads with the sticky header showing topic badges and "Question 1 of X"
    - Verify a spinner appears ("Generating question...") while the LLM call is in progress
    - Verify question title and body appear after generation (check markdown rendering: code blocks should be styled)
    - For a coding question: verify Monaco editor renders (not a textarea)
    - For a theoretical question: verify textarea renders
    - Click "Skip" → verify progress indicator updates to "Question 2 of X"
    - Verify skipping N times where N = question count navigates to /dashboard
    - Verify error state: temporarily set an invalid API key in .env.local → generate fails → error panel with Regenerate button appears
  </verify>
  <done>
    - QuizSession page fetches session from Supabase, initializes QuizContext, generates first question
    - QuestionDisplay renders question with title, type badge, topic badge, difficulty badge, and markdown body
    - ProgressIndicator shows "Question X of Y" and a progress bar, both update correctly after skip
    - AnswerInput renders Monaco editor for coding questions and textarea for theoretical questions
    - Skip button advances to next question; progress indicator reflects the advance
    - Question generation errors show an error panel with Regenerate and Skip options
    - Session completion (all questions answered or skipped) redirects to /dashboard
    - npm run build passes cleanly
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification — full Phase 2 quiz flow in browser</name>
  <action>No automated action. Claude has completed all automated tasks. Human verifies the full end-to-end quiz flow in a real browser using the steps below.</action>
  <files>none — verification only</files>
  <what-built>
    Complete Phase 2 quiz flow:
    - Quiz setup form with topic/difficulty/type/count selectors and Zod validation
    - Quiz session page with LLM-generated questions, markdown rendering, progress indicator, topic badges
    - Monaco editor for coding questions, textarea for theoretical
    - Skip button advancing progress
    - Error states with regenerate option
  </what-built>
  <how-to-verify>
    Run `npm run dev` and test the following in a real browser:

    1. **Setup form validation** (SETUP-01 through SETUP-04):
       - Go to http://localhost:5173/quiz/setup
       - Click "Start Quiz" with no selections — expect validation errors on Topics and Question Types fields
       - Select 2+ topics, choose Normal, check both question types, select 5 questions → click Start Quiz
       - Expect to navigate to /quiz/[uuid]

    2. **Session page loads** (QUIZ-05, QUIZ-06):
       - Verify sticky header shows topic badges for each selected topic
       - Verify "Question 1 of 5" appears in the header with a progress bar at 20%

    3. **Question generates and displays** (QUIZ-01):
       - Wait for spinner to resolve — a question title and body should appear in the main card
       - Verify the question body has proper markdown formatting (if LLM includes code blocks, they should be styled)

    4. **Answer input renders correctly** (QUIZ-02):
       - For a theoretical question: verify a textarea appears below the question
       - For a coding question: verify the Monaco editor (VS Code-style) appears with syntax highlighting
       - If only theoretical questions selected: all questions should show textarea

    5. **Skip works correctly** (QUIZ-03, QUIZ-05):
       - Click "Skip" on question 1
       - Verify "Question 2 of 5" appears in the header
       - Verify a new question starts generating (spinner appears)
       - Skip all remaining questions — verify redirect to /dashboard

    6. **Error handling** (quality gate):
       - Temporarily set VITE_ANTHROPIC_API_KEY to an invalid value in .env.local, restart dev server
       - Start a new session — when question generation fails, verify the red error panel appears with "Regenerate" and "Skip this question" buttons
       - Restore the real API key, restart, confirm normal flow resumes
  </how-to-verify>
  <resume-signal>Type "approved" if all 6 checks pass. Describe any issues found if not.</resume-signal>
  <verify>Human confirms all 6 browser checks pass (described in how-to-verify above)</verify>
  <done>All 10 Phase 2 requirements (SETUP-01 through QUIZ-06) verified in a real browser. Human types "approved".</done>
</task>

</tasks>

<verification>
After the human verification checkpoint passes, run final build verification:

1. `npm run build` — must produce zero TypeScript errors and a clean bundle
2. `npx tsc --noEmit` — clean compile
3. Check Supabase quiz_questions table: after a successful question generation, a row should exist with the correct session_id, question_index, title, body, type, difficulty, topic
4. Phase 2 success criteria cross-check:
   - SETUP-01: Topic checkboxes present and selectable — verified in browser
   - SETUP-02: Difficulty selector with 3 options — verified in browser
   - SETUP-03: Question type checkboxes (coding, theoretical) — verified in browser
   - SETUP-04: Question count radio buttons (5, 10, 20) — verified in browser
   - SETUP-05: Start Quiz creates session and navigates — verified in browser
   - QUIZ-01: Question displays with clear title, body (markdown), type/topic/difficulty labels — verified in browser
   - QUIZ-02: Monaco editor for coding, textarea for theoretical — verified in browser
   - QUIZ-03: Skip button advances to next question — verified in browser
   - QUIZ-05: Progress indicator "Question X of Y" updates correctly — verified in browser
   - QUIZ-06: Session header shows topic badges — verified in browser
</verification>

<success_criteria>
- All 10 Phase 2 requirements (SETUP-01 through QUIZ-06) verified in a real browser
- LLM generates at least one question successfully during verification
- Skip flow works: clicking Skip N times (N = question count) completes the session
- Monaco editor renders for coding questions without bundle-blocking the page load
- npm run build passes cleanly
- Human verification checkpoint: all 6 checks explicitly passed
</success_criteria>

<output>
After completion, create `.planning/phases/02-quiz-setup-and-question-generation/02-04-SUMMARY.md` documenting:
- Human verification results (which checks passed, any issues encountered)
- LLM question quality observations (were any questions visibly off-difficulty or malformed?)
- Monaco editor bundle size impact (check build output for chunk sizes)
- Markdown rendering observations (any XSS concerns, formatting issues)
- Any deviations from this plan and how they were resolved
- Phase 2 completion declaration if all 10 requirements verified
</output>
