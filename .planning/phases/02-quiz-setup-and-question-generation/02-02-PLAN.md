---
phase: 02-quiz-setup-and-question-generation
plan: 02
type: execute
wave: 2
depends_on:
  - 02-01
files_modified:
  - src/components/quiz/QuizSetupForm.tsx
  - src/lib/quiz/sessions.ts
  - src/pages/QuizSetup.tsx
  - src/App.tsx
  - src/components/dashboard/EmptyState.tsx
autonomous: true
requirements:
  - SETUP-01
  - SETUP-02
  - SETUP-03
  - SETUP-04
  - SETUP-05

must_haves:
  truths:
    - "User can navigate from the Dashboard to the quiz setup form"
    - "Quiz setup form shows all 15 available topics as selectable checkboxes (SETUP-01)"
    - "Quiz setup form shows difficulty level selector with beginner, normal, advanced options (SETUP-02)"
    - "Quiz setup form shows question type checkboxes for coding, theoretical, or both (SETUP-03)"
    - "Quiz setup form shows question count selector with 5, 10, 20 options (SETUP-04)"
    - "Selecting zero topics and clicking Start shows a validation error (not a broken session)"
    - "Selecting zero question types and clicking Start shows a validation error"
    - "Valid form submission creates a quiz_sessions row in Supabase and navigates to /quiz/:sessionId (SETUP-05)"
    - "quiz_sessions row in Supabase has correct user_id, topics, difficulty, question_types, question_count"
  artifacts:
    - path: "src/types/quiz.ts"
      provides: "QuizSetupSchema and AVAILABLE_TOPICS used by form validation"
      exports: ["QuizSetupSchema", "QuizSetupFormData", "AVAILABLE_TOPICS"]
    - path: "src/lib/quiz/sessions.ts"
      provides: "createQuizSession() function inserting into quiz_sessions table"
      exports: ["createQuizSession"]
    - path: "src/components/quiz/QuizSetupForm.tsx"
      provides: "Form component with topic checkboxes, difficulty select, type checkboxes, count radio, Zod validation"
      exports: ["QuizSetupForm"]
    - path: "src/pages/QuizSetup.tsx"
      provides: "Page wrapper for QuizSetupForm, handles session creation and navigation to quiz session"
      exports: ["default QuizSetupPage"]
    - path: "src/App.tsx"
      provides: "Route /quiz/setup added as ProtectedRoute"
  key_links:
    - from: "src/pages/QuizSetup.tsx"
      to: "src/lib/quiz/sessions.ts"
      via: "createQuizSession() called on form submit with user.id from useAuth()"
      pattern: "createQuizSession"
    - from: "src/pages/QuizSetup.tsx"
      to: "/quiz/:sessionId"
      via: "navigate() called with session.id after successful createQuizSession()"
      pattern: "navigate.*quiz"
    - from: "src/components/quiz/QuizSetupForm.tsx"
      to: "src/types/quiz.ts"
      via: "zodResolver(QuizSetupSchema) passed to useForm()"
      pattern: "QuizSetupSchema"
    - from: "src/components/dashboard/EmptyState.tsx"
      to: "/quiz/setup"
      via: "CTA button now enabled and links to /quiz/setup"
      pattern: "quiz/setup"
---

<objective>
Build the quiz configuration form and session creation flow: the QuizSetupForm with all four selectors (topics, difficulty, question types, count), validation via React Hook Form + Zod, and the createQuizSession() service that persists configuration to Supabase and navigates to the quiz session page.

Purpose: SETUP-01 through SETUP-05 require a working configuration form that correctly validates user input and creates a persisted session record. The session record is the anchor for all subsequent question generation and answer tracking (Phase 2 and Phase 3).

Output:
- src/lib/quiz/sessions.ts: createQuizSession() with Supabase insert
- src/components/quiz/QuizSetupForm.tsx: full form with topic/difficulty/type/count selectors and validation
- src/pages/QuizSetup.tsx: page wiring useAuth + form + navigation
- src/App.tsx: /quiz/setup route added
- src/components/dashboard/EmptyState.tsx: CTA button enabled, links to /quiz/setup
</objective>

<execution_context>
@/Users/danielvillamizar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielvillamizar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-quiz-setup-and-question-generation/02-RESEARCH.md
@.planning/phases/02-quiz-setup-and-question-generation/02-01-SUMMARY.md

Established patterns from Phase 1:
- useAuth() from src/context/AuthContext.tsx provides user.id and loading state
- ProtectedRoute wraps all authenticated pages in App.tsx
- Dashboard layout: min-h-screen bg-gray-50 flex flex-col with sticky header
- Tailwind CSS via @tailwindcss/vite (no config file needed, classes apply directly)
- Form pattern: useState for error/loading, try/catch around async call, navigate on success

Phase 2 dependencies (from 02-01):
- QuizSetupSchema, QuizSetupFormData, AVAILABLE_TOPICS from src/types/quiz.ts
- QuizSessionInsert type from src/types/database.ts
- supabase client from src/lib/supabase.ts
- react-hook-form, @hookform/resolvers, zod installed
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create quiz session service</name>
  <files>
    src/lib/quiz/sessions.ts
  </files>
  <action>
    Create `src/lib/quiz/sessions.ts`:

    ```typescript
    // src/lib/quiz/sessions.ts
    // Service functions for quiz session lifecycle management.
    // createQuizSession() is called by QuizSetupPage on form submission.
    // Returns the created session row so the caller can navigate to /quiz/:sessionId.
    import { supabase } from '../supabase'
    import type { QuizSetupFormData } from '../../types/quiz'
    import type { QuizSessionRow } from '../../types/database'

    export async function createQuizSession(
      userId: string,
      config: QuizSetupFormData
    ): Promise<QuizSessionRow> {
      const { data, error } = await supabase
        .from('quiz_sessions')
        .insert({
          user_id: userId,
          topics: config.topics,
          difficulty: config.difficulty,
          question_types: config.questionTypes,
          question_count: parseInt(config.questionCount, 10) as 5 | 10 | 20,
          status: 'in_progress'
        })
        .select()
        .single()

      if (error) throw new Error(`Failed to create quiz session: ${error.message}`)
      if (!data) throw new Error('No data returned from quiz session creation')

      return data
    }

    export async function getQuizSession(sessionId: string): Promise<QuizSessionRow | null> {
      const { data, error } = await supabase
        .from('quiz_sessions')
        .select('*')
        .eq('id', sessionId)
        .single()

      if (error) {
        if (error.code === 'PGRST116') return null // Not found
        throw new Error(`Failed to fetch quiz session: ${error.message}`)
      }

      return data
    }
    ```

    This module is intentionally thin — it performs exactly one Supabase operation per function, making it easy to test and reason about. Question generation is kept separate in Plan 02-03 (src/lib/quiz/questions.ts).
  </action>
  <verify>
    - Run: `npx tsc --noEmit` — createQuizSession and getQuizSession must type-check cleanly
    - Confirm the insert payload matches the QuizSessionInsert type (user_id, topics, difficulty, question_types, question_count, status)
    - Confirm the return type is QuizSessionRow (not any)
  </verify>
  <done>
    - src/lib/quiz/sessions.ts exists and exports createQuizSession() and getQuizSession()
    - createQuizSession() inserts into quiz_sessions and returns the full row
    - TypeScript compiles cleanly
  </done>
</task>

<task type="auto">
  <name>Task 2: Build QuizSetupForm component and QuizSetup page</name>
  <files>
    src/components/quiz/QuizSetupForm.tsx
    src/pages/QuizSetup.tsx
    src/App.tsx
    src/components/dashboard/EmptyState.tsx
  </files>
  <action>
    **src/components/quiz/QuizSetupForm.tsx** — Form with all four configuration selectors:

    ```tsx
    // src/components/quiz/QuizSetupForm.tsx
    // Quiz configuration form. Uses React Hook Form + Zod for validation.
    // Validates that at least one topic and one question type are selected before submit.
    import { useForm } from 'react-hook-form'
    import { zodResolver } from '@hookform/resolvers/zod'
    import { QuizSetupSchema, AVAILABLE_TOPICS } from '../../types/quiz'
    import type { QuizSetupFormData } from '../../types/quiz'

    interface QuizSetupFormProps {
      onSubmit: (data: QuizSetupFormData) => Promise<void>
      error?: string | null
    }

    export function QuizSetupForm({ onSubmit, error }: QuizSetupFormProps) {
      const {
        register,
        handleSubmit,
        formState: { errors, isSubmitting }
      } = useForm<QuizSetupFormData>({
        resolver: zodResolver(QuizSetupSchema),
        defaultValues: {
          topics: [],
          difficulty: 'normal',
          questionTypes: [],
          questionCount: '10'
        }
      })

      return (
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-8">
          {/* Global error from parent (e.g. Supabase insert failure) */}
          {error && (
            <div className="rounded-md bg-red-50 border border-red-200 p-4">
              <p className="text-sm text-red-700">{error}</p>
            </div>
          )}

          {/* SETUP-01: Programming Topics (multi-select checkboxes) */}
          <fieldset>
            <legend className="text-sm font-semibold text-gray-900 mb-3">
              Programming Topics <span className="text-red-500">*</span>
            </legend>
            <div className="grid grid-cols-2 sm:grid-cols-3 gap-2">
              {AVAILABLE_TOPICS.map((topic) => (
                <label
                  key={topic}
                  className="flex items-center gap-2 rounded-md border border-gray-200 px-3 py-2 text-sm cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300"
                >
                  <input
                    type="checkbox"
                    value={topic}
                    {...register('topics')}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  {topic}
                </label>
              ))}
            </div>
            {errors.topics && (
              <p className="mt-2 text-sm text-red-600">{errors.topics.message}</p>
            )}
          </fieldset>

          {/* SETUP-02: Difficulty Level */}
          <div>
            <label htmlFor="difficulty" className="block text-sm font-semibold text-gray-900 mb-2">
              Difficulty <span className="text-red-500">*</span>
            </label>
            <select
              id="difficulty"
              {...register('difficulty')}
              className="w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            >
              <option value="beginner">Beginner — fundamentals, basic syntax</option>
              <option value="normal">Normal — real-world scenarios, moderate complexity</option>
              <option value="advanced">Advanced — edge cases, architecture, performance</option>
            </select>
            {errors.difficulty && (
              <p className="mt-1 text-sm text-red-600">{errors.difficulty.message}</p>
            )}
          </div>

          {/* SETUP-03: Question Types */}
          <fieldset>
            <legend className="text-sm font-semibold text-gray-900 mb-3">
              Question Types <span className="text-red-500">*</span>
            </legend>
            <div className="space-y-2">
              {[
                { value: 'coding', label: 'Coding Problems', description: 'Write or review code to solve a problem' },
                { value: 'theoretical', label: 'Theoretical Questions', description: 'Explain concepts, tradeoffs, or best practices' }
              ].map(({ value, label, description }) => (
                <label
                  key={value}
                  className="flex items-start gap-3 rounded-md border border-gray-200 px-4 py-3 cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300"
                >
                  <input
                    type="checkbox"
                    value={value}
                    {...register('questionTypes')}
                    className="mt-0.5 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span>
                    <span className="block text-sm font-medium text-gray-900">{label}</span>
                    <span className="block text-xs text-gray-500">{description}</span>
                  </span>
                </label>
              ))}
            </div>
            {errors.questionTypes && (
              <p className="mt-2 text-sm text-red-600">{errors.questionTypes.message}</p>
            )}
          </fieldset>

          {/* SETUP-04: Number of Questions */}
          <fieldset>
            <legend className="text-sm font-semibold text-gray-900 mb-3">
              Number of Questions <span className="text-red-500">*</span>
            </legend>
            <div className="flex gap-3">
              {(['5', '10', '20'] as const).map((count) => (
                <label
                  key={count}
                  className="flex-1 flex items-center justify-center gap-2 rounded-md border border-gray-200 px-3 py-3 text-sm cursor-pointer hover:bg-gray-50 has-[:checked]:bg-blue-50 has-[:checked]:border-blue-300 has-[:checked]:font-semibold"
                >
                  <input
                    type="radio"
                    value={count}
                    {...register('questionCount')}
                    className="border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  {count} questions
                </label>
              ))}
            </div>
            {errors.questionCount && (
              <p className="mt-1 text-sm text-red-600">{errors.questionCount.message}</p>
            )}
          </fieldset>

          {/* SETUP-05: Start Quiz button */}
          <button
            type="submit"
            disabled={isSubmitting}
            className="w-full rounded-md bg-blue-600 px-4 py-3 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
          >
            {isSubmitting ? 'Creating session...' : 'Start Quiz'}
          </button>
        </form>
      )
    }
    ```

    **src/pages/QuizSetup.tsx** — Page wrapper:

    ```tsx
    // src/pages/QuizSetup.tsx
    // Quiz setup page: renders QuizSetupForm, handles session creation and navigation.
    // On valid form submit: calls createQuizSession(), navigates to /quiz/:sessionId.
    import { useState } from 'react'
    import { useNavigate } from 'react-router-dom'
    import { useAuth } from '../context/AuthContext'
    import { QuizSetupForm } from '../components/quiz/QuizSetupForm'
    import { createQuizSession } from '../lib/quiz/sessions'
    import type { QuizSetupFormData } from '../types/quiz'

    export default function QuizSetupPage() {
      const { user } = useAuth()
      const navigate = useNavigate()
      const [error, setError] = useState<string | null>(null)

      const handleSubmit = async (data: QuizSetupFormData) => {
        if (!user) return
        setError(null)

        try {
          const session = await createQuizSession(user.id, data)
          navigate(`/quiz/${session.id}`)
        } catch (err) {
          setError(err instanceof Error ? err.message : 'Failed to start quiz. Please try again.')
        }
      }

      return (
        <div className="min-h-screen bg-gray-50">
          <div className="mx-auto max-w-2xl px-4 py-12">
            <div className="mb-8">
              <h1 className="text-2xl font-bold text-gray-900">Configure Your Quiz</h1>
              <p className="mt-1 text-sm text-gray-500">
                Select your topics, difficulty, and format, then start your session.
              </p>
            </div>

            <div className="rounded-lg bg-white shadow-sm border border-gray-200 p-6">
              <QuizSetupForm onSubmit={handleSubmit} error={error} />
            </div>
          </div>
        </div>
      )
    }
    ```

    **Update src/App.tsx** — Add /quiz/setup and /quiz/:sessionId routes:

    Import QuizSetupPage and add routes inside the existing Routes block:
    ```tsx
    import QuizSetupPage from './pages/QuizSetup'
    // Add inside <Routes> after the /dashboard route:
    <Route
      path="/quiz/setup"
      element={
        <ProtectedRoute>
          <QuizSetupPage />
        </ProtectedRoute>
      }
    />
    <Route
      path="/quiz/:sessionId"
      element={
        <ProtectedRoute>
          {/* QuizSessionPage added in Plan 02-04 */}
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <p className="text-gray-500">Loading quiz session...</p>
          </div>
        </ProtectedRoute>
      }
    />
    ```

    **Update src/components/dashboard/EmptyState.tsx** — Enable the CTA button:

    Change the disabled "Start a quiz session" button to a working link to /quiz/setup.
    Replace the disabled button with a React Router Link (import Link from 'react-router-dom'):
    ```tsx
    import { Link } from 'react-router-dom'
    // Replace disabled button with:
    <Link
      to="/quiz/setup"
      className="inline-flex items-center rounded-md bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors"
    >
      Start a quiz session
    </Link>
    ```
  </action>
  <verify>
    - Run: `npm run build` — must succeed with zero TypeScript errors
    - Run: `npm run dev`, navigate to http://localhost:5173/dashboard — "Start a quiz session" button should now be a clickable link (not disabled)
    - Click "Start a quiz session" — should navigate to /quiz/setup
    - On /quiz/setup: all 15 topics should appear as checkboxes
    - Try clicking "Start Quiz" with no selections — should show validation errors for topics and questionTypes
    - Select 2 topics, Beginner, Coding, 5 questions → click "Start Quiz"
    - Verify in Supabase Dashboard → Table Editor → quiz_sessions: a row exists with correct user_id, topics, difficulty, question_types, question_count
    - After submission, URL should change to /quiz/[uuid] showing the placeholder "Loading quiz session..." text
  </verify>
  <done>
    - QuizSetupForm renders with all 15 topic checkboxes, difficulty select, 2 type checkboxes, 3 count radio buttons
    - Zod validation fires on submit: empty topics or empty questionTypes shows error message, prevents submission
    - Valid submission creates quiz_sessions row in Supabase with correct user_id and config
    - Navigation to /quiz/:sessionId occurs after successful session creation
    - Dashboard CTA button is enabled and links to /quiz/setup
    - npm run build passes
  </done>
</task>

</tasks>

<verification>
After all tasks complete, run full flow verification:

1. `npm run build` — must succeed with zero TypeScript errors
2. `npm run dev` → login → dashboard → click "Start a quiz session" → arrives at /quiz/setup
3. Submit with no selections → see validation errors (not a blank form or console error)
4. Fill form: select JavaScript + TypeScript, Normal, Theoretical, 10 → click "Start Quiz"
5. Verify in Supabase quiz_sessions table: new row with topics=['JavaScript','TypeScript'], difficulty='normal', question_types=['theoretical'], question_count=10
6. URL changes to /quiz/[uuid] — placeholder content shown (full quiz session UI added in Plan 02-04)
</verification>

<success_criteria>
- Quiz setup form renders all selectors with correct values matching SETUP-01 through SETUP-04
- Zod validation prevents submission when topics or questionTypes are empty
- Valid submission creates quiz_sessions row in Supabase and navigates to /quiz/:sessionId
- EmptyState CTA button is no longer disabled — links to /quiz/setup
- npm run build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/02-quiz-setup-and-question-generation/02-02-SUMMARY.md` documenting:
- Form validation behavior observed during testing
- Exact Supabase row structure created on successful submit
- Any React Hook Form or Zod resolver quirks encountered
- Any deviations from this plan
</output>
