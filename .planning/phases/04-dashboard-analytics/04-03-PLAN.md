---
phase: 04-dashboard-analytics
plan: 03
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/lib/dashboard/sessionDetail.ts
  - src/hooks/useSessionDetail.ts
  - src/pages/SessionDetail.tsx
  - src/App.tsx
  - src/components/dashboard/SessionHistoryList.tsx
autonomous: true
requirements: [DASH-03]

must_haves:
  truths:
    - "User can navigate from the dashboard session list to a detail view of any past session"
    - "Session detail view shows every question from the session with its body and topic"
    - "Session detail view shows the user's submitted answer for each question"
    - "Session detail view shows the LLM score, feedback, and model answer for each answered question"
    - "Skipped questions are shown with a 'Skipped' badge (no feedback or score displayed)"
    - "A 'Back to Dashboard' navigation link is present on the detail page"
  artifacts:
    - path: "src/lib/dashboard/sessionDetail.ts"
      provides: "getSessionWithAnswers() fetching session + questions + answers in one join query"
      exports: ["getSessionWithAnswers", "SessionDetailData"]
    - path: "src/hooks/useSessionDetail.ts"
      provides: "useSessionDetail() React Query hook for detail data"
      exports: ["useSessionDetail"]
    - path: "src/pages/SessionDetail.tsx"
      provides: "Session detail page rendering all Q/A/feedback"
      min_lines: 100
  key_links:
    - from: "src/components/dashboard/SessionHistoryList.tsx"
      to: "/session/:sessionId/detail"
      via: "Link on each session row"
      pattern: "session.*detail"
    - from: "src/lib/dashboard/sessionDetail.ts"
      to: "supabase.from('quiz_sessions').select('*,quiz_questions(*),quiz_answers(*)')"
      via: "Single join query — no N+1"
      pattern: "quiz_questions.*quiz_answers"
    - from: "src/pages/SessionDetail.tsx"
      to: "/dashboard"
      via: "Back link"
      pattern: "dashboard"
---

<objective>
Implement the session detail view so users can drill into any past session and review all questions, their submitted answers, scores, feedback, and model answers. Uses a single Supabase join query (quiz_sessions + quiz_questions + quiz_answers) to avoid N+1 pitfall documented in RESEARCH.md.

Purpose: Closes DASH-03 — the "drill into any past session" capability. Without this, the dashboard session list is read-only with no way to learn from past performance at the question level.
Output: `getSessionWithAnswers()` service, `useSessionDetail()` hook, `SessionDetailPage`, route added to App.tsx, detail link added to SessionHistoryList rows.
</objective>

<execution_context>
@/Users/danielvillamizar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielvillamizar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-dashboard-analytics/04-RESEARCH.md
@.planning/phases/04-dashboard-analytics/04-01-SUMMARY.md
@src/types/database.ts
@src/App.tsx
@src/components/dashboard/SessionHistoryList.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: getSessionWithAnswers() service + useSessionDetail() hook</name>
  <files>
    src/lib/dashboard/sessionDetail.ts
    src/hooks/useSessionDetail.ts
  </files>
  <action>
    **Create src/lib/dashboard/sessionDetail.ts:**

    Single join query pattern — one Supabase call fetches session, questions, and answers. This avoids the N+1 pitfall documented in the RESEARCH.md (pitfall 1). Questions and answers are correlated by `question_index` (denormalized onto quiz_answers in Phase 3 decision [03-01]).

    ```typescript
    // src/lib/dashboard/sessionDetail.ts
    // Fetches a full session with all questions and answers for the detail view (DASH-03).
    // Single join query: quiz_sessions + quiz_questions + quiz_answers — no N+1.
    import { supabase } from '../supabase'
    import type { QuizSessionRow, QuizQuestionRow, QuizAnswerRow } from '../../types/database'

    export interface QuestionWithAnswer {
      question: QuizQuestionRow
      answer: QuizAnswerRow | null  // null if no answer row exists for this question_index
    }

    export interface SessionDetailData {
      session: QuizSessionRow
      questionsWithAnswers: QuestionWithAnswer[]
    }

    export async function getSessionWithAnswers(sessionId: string): Promise<SessionDetailData | null> {
      const { data, error } = await supabase
        .from('quiz_sessions')
        .select(`
          *,
          quiz_questions (
            id,
            session_id,
            question_index,
            title,
            body,
            type,
            difficulty,
            topic,
            expected_format,
            created_at
          ),
          quiz_answers (
            id,
            session_id,
            question_id,
            question_index,
            user_answer,
            status,
            score,
            reasoning,
            feedback,
            model_answer,
            created_at,
            updated_at
          )
        `)
        .eq('id', sessionId)
        .single()

      if (error || !data) {
        if (error?.code === 'PGRST116') return null  // Not found
        throw new Error(`Failed to fetch session detail: ${error?.message}`)
      }

      const session = data as QuizSessionRow & {
        quiz_questions: QuizQuestionRow[]
        quiz_answers: QuizAnswerRow[]
      }

      // Build lookup: question_index → answer row
      const answerByIndex = new Map<number, QuizAnswerRow>()
      session.quiz_answers.forEach(a => answerByIndex.set(a.question_index, a))

      // Sort questions by question_index for display order
      const sortedQuestions = [...session.quiz_questions].sort(
        (a, b) => a.question_index - b.question_index
      )

      const questionsWithAnswers: QuestionWithAnswer[] = sortedQuestions.map(q => ({
        question: q,
        answer: answerByIndex.get(q.question_index) ?? null
      }))

      return {
        session: {
          id: session.id,
          user_id: session.user_id,
          topics: session.topics,
          difficulty: session.difficulty,
          question_types: session.question_types,
          question_count: session.question_count,
          status: session.status,
          created_at: session.created_at,
          updated_at: session.updated_at
        } as QuizSessionRow,
        questionsWithAnswers
      }
    }
    ```

    **Create src/hooks/useSessionDetail.ts:**

    React Query hook. Keyed by sessionId. Lazy — only fetches when `sessionId` is truthy.

    ```typescript
    // src/hooks/useSessionDetail.ts
    // React Query hook for single session detail: session + questions + answers.
    import { useQuery } from '@tanstack/react-query'
    import { getSessionWithAnswers } from '../lib/dashboard/sessionDetail'

    export function useSessionDetail(sessionId: string | undefined) {
      return useQuery({
        queryKey: ['session-detail', sessionId],
        queryFn: () => getSessionWithAnswers(sessionId!),
        enabled: !!sessionId,
        staleTime: 10 * 60 * 1000  // 10 minutes — detail views rarely change after session completes
      })
    }
    ```
  </action>
  <verify>
    Run: `npx tsc -p tsconfig.app.json --noEmit` — 0 errors.
    Check: `src/lib/dashboard/sessionDetail.ts` exports `getSessionWithAnswers` and `SessionDetailData`.
    Check: `src/hooks/useSessionDetail.ts` exports `useSessionDetail`.
    Check: The `.select()` call includes `quiz_questions` and `quiz_answers` nested selects (no separate queries).
  </verify>
  <done>
    TypeScript compiles clean. `getSessionWithAnswers()` uses one join query. `useSessionDetail()` wraps it in useQuery with sessionId cache key.
  </done>
</task>

<task type="auto">
  <name>Task 2: SessionDetailPage + router + SessionHistoryList detail link</name>
  <files>
    src/pages/SessionDetail.tsx
    src/App.tsx
    src/components/dashboard/SessionHistoryList.tsx
  </files>
  <action>
    **Create src/pages/SessionDetail.tsx:**

    Renders all questions in order with their answers. Each question card shows: question title + body (markdown-rendered via markdown-it, same pattern as Phase 2 QuestionDisplay), topic/difficulty/type badges, then the answer section (user answer, score with color coding, feedback, model answer). Skipped questions show a grey "Skipped" badge.

    Use `markdown-it` for rendering question body and feedback — it's already installed. Match the Phase 2/3 pattern (`md.render(text)` → `dangerouslySetInnerHTML` with `html: false`).

    ```typescript
    // src/pages/SessionDetail.tsx
    // Past session detail view — all questions with user answers, scores, feedback, model answers.
    // DASH-03: user can view all Q/A/feedback for any past session.
    import { useParams, Link } from 'react-router-dom'
    import MarkdownIt from 'markdown-it'
    import { format } from 'date-fns'
    import { useSessionDetail } from '../hooks/useSessionDetail'
    import { getScoreColor, getScoreBgColor } from '../lib/dashboard/recommendations'

    const md = new MarkdownIt({ html: false, linkify: true, typographer: true })

    export default function SessionDetailPage() {
      const { sessionId } = useParams<{ sessionId: string }>()
      const { data, isLoading, error } = useSessionDetail(sessionId)

      if (isLoading) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <p className="text-gray-500">Loading session...</p>
          </div>
        )
      }

      if (error || !data) {
        return (
          <div className="min-h-screen bg-gray-50 flex items-center justify-center">
            <div className="text-center">
              <p className="text-red-600 mb-3">Failed to load session.</p>
              <Link to="/dashboard" className="text-blue-600 underline text-sm">Back to Dashboard</Link>
            </div>
          </div>
        )
      }

      const { session, questionsWithAnswers } = data
      const difficultyLabel: Record<string, string> = {
        beginner: 'Beginner', normal: 'Intermediate', advanced: 'Advanced'
      }

      return (
        <div className="min-h-screen bg-gray-50 py-8 px-4">
          <div className="max-w-3xl mx-auto space-y-6">
            {/* Header */}
            <div>
              <Link to="/dashboard" className="text-sm text-blue-600 hover:underline">
                ← Back to Dashboard
              </Link>
              <h1 className="text-xl font-bold text-gray-900 mt-2">
                {session.topics.join(', ')}
              </h1>
              <p className="text-gray-500 text-sm">
                {difficultyLabel[session.difficulty]}
                {' · '}
                {format(new Date(session.created_at), 'MMM d, yyyy · h:mm a')}
                {' · '}
                {questionsWithAnswers.length} questions
              </p>
            </div>

            {/* Questions */}
            {questionsWithAnswers.map(({ question, answer }, idx) => {
              const isSkipped = answer?.status === 'skipped'
              const isCompleted = answer?.status === 'completed'
              const score = answer?.score ?? null

              return (
                <div
                  key={question.id}
                  className="bg-white rounded-xl border border-gray-200 overflow-hidden"
                >
                  {/* Question header */}
                  <div className="px-5 py-4 border-b border-gray-100">
                    <div className="flex items-center gap-2 mb-2">
                      <span className="text-xs font-medium text-gray-400">Q{idx + 1}</span>
                      <span className="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full">
                        {question.topic}
                      </span>
                      <span className="px-2 py-0.5 bg-gray-100 text-gray-600 text-xs rounded-full">
                        {question.type}
                      </span>
                      {isSkipped && (
                        <span className="px-2 py-0.5 bg-gray-200 text-gray-500 text-xs rounded-full">
                          Skipped
                        </span>
                      )}
                      {isCompleted && score !== null && (
                        <span className={`px-2 py-0.5 text-xs rounded-full font-semibold ${getScoreBgColor(score)} ${getScoreColor(score)}`}>
                          {score}/100
                        </span>
                      )}
                    </div>
                    <h3 className="font-semibold text-gray-800">{question.title}</h3>
                  </div>

                  {/* Question body */}
                  <div className="px-5 py-4 border-b border-gray-100">
                    <div
                      className="prose prose-sm max-w-none text-gray-700"
                      dangerouslySetInnerHTML={{ __html: md.render(question.body) }}
                    />
                  </div>

                  {/* Answer section */}
                  {!isSkipped && answer && (
                    <div className="divide-y divide-gray-100">
                      {/* User answer */}
                      {answer.user_answer && (
                        <div className="px-5 py-4">
                          <p className="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">
                            Your Answer
                          </p>
                          <pre className="text-sm text-gray-700 whitespace-pre-wrap font-mono bg-gray-50 rounded p-3">
                            {answer.user_answer}
                          </pre>
                        </div>
                      )}

                      {/* Feedback */}
                      {answer.feedback && (
                        <div className="px-5 py-4">
                          <p className="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">
                            Feedback
                          </p>
                          <div
                            className="prose prose-sm max-w-none text-gray-700"
                            dangerouslySetInnerHTML={{ __html: md.render(answer.feedback) }}
                          />
                        </div>
                      )}

                      {/* Model answer */}
                      {answer.model_answer && (
                        <div className="px-5 py-4">
                          <p className="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-2">
                            Model Answer
                          </p>
                          <div
                            className="prose prose-sm max-w-none text-gray-700"
                            dangerouslySetInnerHTML={{ __html: md.render(answer.model_answer) }}
                          />
                        </div>
                      )}
                    </div>
                  )}

                  {isSkipped && (
                    <div className="px-5 py-4 text-sm text-gray-400 italic">
                      This question was skipped.
                    </div>
                  )}
                </div>
              )
            })}
          </div>
        </div>
      )
    }
    ```

    **Update src/App.tsx:**

    Import `SessionDetailPage` from `./pages/SessionDetail`. Add a ProtectedRoute for `/session/:sessionId/detail` (separate from the summary route already added in Plan 04-01):

    ```tsx
    import SessionDetailPage from './pages/SessionDetail'

    // Add inside the Routes block, after the /session/:sessionId/summary route:
    <Route
      path="/session/:sessionId/detail"
      element={
        <ProtectedRoute>
          <SessionDetailPage />
        </ProtectedRoute>
      }
    />
    ```

    **Update src/components/dashboard/SessionHistoryList.tsx:**

    Add a "View Details" link to each session row. Each row currently links to `/session/${row.session_id}/summary`. Change the row to be a `<div>` layout with the main area linking to summary AND a separate "Details" text link to `/session/${row.session_id}/detail`.

    Update each session row from:
    ```tsx
    <Link key={row.session_id} to={`/session/${row.session_id}/summary`} className="...">
      {/* row content */}
    </Link>
    ```

    To:
    ```tsx
    <div key={row.session_id} className="block bg-white rounded-lg border border-gray-200 px-4 py-3 hover:border-blue-300 hover:shadow-sm transition-all">
      <div className="flex items-center justify-between">
        <Link to={`/session/${row.session_id}/summary`} className="min-w-0 flex-1">
          <p className="text-sm font-medium text-gray-800 truncate">
            {row.topics.join(', ')}
          </p>
          <p className="text-xs text-gray-400 mt-0.5">
            {format(new Date(row.created_at), 'MMM d, yyyy · h:mm a')}
            {' · '}
            {row.difficulty.charAt(0).toUpperCase() + row.difficulty.slice(1)}
            {' · '}
            {formatDuration(row.duration_seconds)}
          </p>
        </Link>
        <div className="ml-4 flex-shrink-0 flex items-center gap-3">
          <Link
            to={`/session/${row.session_id}/detail`}
            className="text-xs text-blue-600 hover:underline"
          >
            Details
          </Link>
          <div className="text-right">
            <span className={`text-2xl font-bold ${getScoreColor(row.final_score)}`}>
              {row.final_score}
            </span>
            <p className="text-xs text-gray-400">
              {row.num_completed}✓ {row.num_skipped}↷
            </p>
          </div>
        </div>
      </div>
    </div>
    ```
  </action>
  <verify>
    Run: `npx tsc -p tsconfig.app.json --noEmit` — 0 errors.
    Check: `src/pages/SessionDetail.tsx` exists with `useSessionDetail` import.
    Check: `src/App.tsx` contains route `/session/:sessionId/detail`.
    Check: `src/components/dashboard/SessionHistoryList.tsx` contains link to `/session/${row.session_id}/detail`.
    Check: `src/lib/dashboard/sessionDetail.ts` `getSessionWithAnswers()` uses single `.select()` with nested `quiz_questions` and `quiz_answers`.
  </verify>
  <done>
    TypeScript compiles clean. Session detail page accessible at `/session/:sessionId/detail`. Dashboard session rows have "Details" link. Detail page shows all questions with user answers, scores, feedback, model answers. Skipped questions show "Skipped" badge with no feedback.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -p tsconfig.app.json --noEmit` → 0 errors
2. `src/lib/dashboard/sessionDetail.ts` uses single Supabase join query (no N+1)
3. `src/hooks/useSessionDetail.ts` uses React Query with sessionId cache key
4. `src/pages/SessionDetail.tsx` renders all Q/A with feedback and model answers
5. `src/App.tsx` has `/session/:sessionId/detail` ProtectedRoute
6. `src/components/dashboard/SessionHistoryList.tsx` has "Details" link per session row
7. Skipped questions display "Skipped" badge without score/feedback
</verification>

<success_criteria>
- Clicking "Details" on any dashboard session row navigates to `/session/:sessionId/detail`
- Detail page shows all questions in order with body, topic, type badges
- Each completed question shows: user answer, score (color-coded), feedback, model answer
- Each skipped question shows: question title/body + "Skipped" badge, no feedback section
- "Back to Dashboard" link returns to /dashboard
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-dashboard-analytics/04-03-SUMMARY.md`
</output>
