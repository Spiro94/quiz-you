---
phase: 04-dashboard-analytics
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/lib/dashboard/sessions.ts
  - src/hooks/useSessions.ts
  - src/components/dashboard/SessionHistoryList.tsx
  - src/components/dashboard/FilterBar.tsx
  - src/pages/Dashboard.tsx
  - src/App.tsx
autonomous: true
requirements: [DASH-01, DASH-02, DASH-07]

must_haves:
  truths:
    - "Dashboard page shows a list of recent quiz sessions (up to 10, ordered by most recent first)"
    - "Each session row shows: date, topics covered, final score with color coding, and duration"
    - "User can filter sessions by topic using a dropdown selector"
    - "User can filter sessions by date range using date inputs"
    - "Pagination controls allow user to move between pages of sessions (prev/next)"
    - "Applying filters re-fetches data from session_summaries — not a client-side slice"
    - "Empty state shown when no sessions exist or no results match filters"
  artifacts:
    - path: "src/lib/dashboard/sessions.ts"
      provides: "getSessionList() querying session_summaries with filters and pagination"
      exports: ["getSessionList", "FilterOptions"]
    - path: "src/hooks/useSessions.ts"
      provides: "useSessions() React Query hook with filter state"
      exports: ["useSessions"]
    - path: "src/components/dashboard/SessionHistoryList.tsx"
      provides: "Table/list component for session history"
      min_lines: 60
    - path: "src/components/dashboard/FilterBar.tsx"
      provides: "Filter controls: topic dropdown + date range inputs"
      min_lines: 40
    - path: "src/pages/Dashboard.tsx"
      provides: "Updated dashboard page with SessionHistoryList + FilterBar replacing EmptyState"
      contains: "SessionHistoryList"
  key_links:
    - from: "src/hooks/useSessions.ts"
      to: "src/lib/dashboard/sessions.ts"
      via: "getSessionList() called inside useQuery queryFn"
      pattern: "getSessionList"
    - from: "src/lib/dashboard/sessions.ts"
      to: "supabase.from('session_summaries')"
      via: "Supabase query with .range() pagination and filter clauses"
      pattern: "session_summaries"
    - from: "src/pages/Dashboard.tsx"
      to: "src/hooks/useSessions.ts"
      via: "useSessions() hook providing data to SessionHistoryList"
      pattern: "useSessions"
---

<objective>
Install `date-fns`, implement the `getSessionList()` data service querying `session_summaries`, build the `useSessions()` React Query hook with filter state, create `SessionHistoryList` and `FilterBar` components, and replace the placeholder `EmptyState` in `DashboardPage` with the real session history list.

Purpose: Closes DASH-01, DASH-02, DASH-07 — the dashboard's core value as a history browser. Users who land on the dashboard after login now see their actual past sessions with date, topics, score, and duration.
Output: Functional paginated session history list with topic and date filtering.
</objective>

<execution_context>
@/Users/danielvillamizar/.claude/get-shit-done/workflows/execute-plan.md
@/Users/danielvillamizar/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-dashboard-analytics/04-RESEARCH.md
@.planning/phases/04-dashboard-analytics/04-01-SUMMARY.md
@src/types/database.ts
@src/pages/Dashboard.tsx
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install date-fns + implement getSessionList() + useSessions() hook</name>
  <files>
    src/lib/dashboard/sessions.ts
    src/hooks/useSessions.ts
  </files>
  <action>
    **Install dependency:**
    ```bash
    npm install date-fns
    ```

    **Create src/lib/dashboard/sessions.ts:**

    Data access layer for session_summaries table. Uses server-side pagination via Supabase `.range()`. Filter parameters map directly to query clauses (no client-side filtering).

    ```typescript
    // src/lib/dashboard/sessions.ts
    // Data access for session history. Queries the denormalized session_summaries table.
    // Uses server-side pagination (Supabase .range()) and filter clauses.
    import { supabase } from '../supabase'
    import type { SessionSummaryRow } from '../../types/database'

    export interface FilterOptions {
      page?: number
      pageSize?: number
      dateRange?: { start?: string; end?: string }  // ISO date strings (YYYY-MM-DD)
      topics?: string[]
    }

    export async function getSessionList(
      userId: string,
      options: FilterOptions = {}
    ): Promise<SessionSummaryRow[]> {
      const { page = 0, pageSize = 10, dateRange, topics } = options

      let query = supabase
        .from('session_summaries')
        .select('*')
        .eq('user_id', userId)
        .order('created_at', { ascending: false })

      if (dateRange?.start) {
        query = query.gte('created_at', dateRange.start)
      }
      if (dateRange?.end) {
        // Include the entire end date: append T23:59:59 to make the filter inclusive of the day
        query = query.lte('created_at', `${dateRange.end}T23:59:59`)
      }
      if (topics && topics.length > 0) {
        // Supabase PostgREST: overlaps() checks if topics[] intersects with filter topics
        query = query.overlaps('topics', topics)
      }

      const { data, error } = await query.range(page * pageSize, (page + 1) * pageSize - 1)

      if (error) throw new Error(`Failed to fetch sessions: ${error.message}`)
      return (data ?? []) as SessionSummaryRow[]
    }
    ```

    **Create src/hooks/useSessions.ts:**

    TanStack React Query hook. Filter state lives in component via URL search params (per RESEARCH.md pitfall guidance — pagination in URL). This hook accepts filter state as props from the component.

    ```typescript
    // src/hooks/useSessions.ts
    // React Query hook for paginated, filtered session history from session_summaries.
    // Query key includes all filter params — React Query auto-refetches on filter change.
    import { useQuery } from '@tanstack/react-query'
    import { useAuth } from '../context/AuthContext'
    import { getSessionList, type FilterOptions } from '../lib/dashboard/sessions'

    export function useSessions(options: FilterOptions = {}) {
      const { user } = useAuth()

      return useQuery({
        queryKey: ['sessions', user?.id, options.page, options.pageSize, options.dateRange, options.topics],
        queryFn: () => getSessionList(user!.id, options),
        enabled: !!user?.id,
        staleTime: 5 * 60 * 1000 // 5 minutes
      })
    }
    ```

    Note: `@tanstack/react-query` is already installed in package.json. Do NOT install it again.
    Note: `date-fns` type definitions are bundled with `date-fns` itself — no `@types/date-fns` needed.
  </action>
  <verify>
    Run: `npx tsc -p tsconfig.app.json --noEmit` — 0 errors.
    Check: `src/lib/dashboard/sessions.ts` exists, exports `getSessionList` and `FilterOptions`.
    Check: `src/hooks/useSessions.ts` exists, exports `useSessions`.
    Check: `node_modules/date-fns` directory exists (installed successfully).
  </verify>
  <done>
    TypeScript compiles clean. `getSessionList()` queries session_summaries with pagination and filter clauses. `useSessions()` hook wraps it in useQuery with filter-aware cache key.
  </done>
</task>

<task type="auto">
  <name>Task 2: FilterBar + SessionHistoryList components + Dashboard page update</name>
  <files>
    src/components/dashboard/FilterBar.tsx
    src/components/dashboard/SessionHistoryList.tsx
    src/pages/Dashboard.tsx
  </files>
  <action>
    **Create src/components/dashboard/FilterBar.tsx:**

    Filter controls for topic dropdown and date range. Uses React state, calls `onFilterChange` callback prop. The AVAILABLE_TOPICS list uses the same topic list established in Phase 2 QuizSetupForm. Use simple HTML `<input type="date">` — no external date picker library needed.

    ```typescript
    // src/components/dashboard/FilterBar.tsx
    // Filter bar for session history: topic multi-select and date range inputs.
    // Purely presentational — calls onFilterChange callback when filters change.
    import { useState } from 'react'

    // Matches Phase 2 QuizSetupForm topic list
    const AVAILABLE_TOPICS = [
      'JavaScript', 'TypeScript', 'Python', 'Java', 'Go', 'Rust',
      'Dart', 'Flutter', 'React', 'Node.js', 'SQL', 'System Design'
    ]

    export interface FilterState {
      selectedTopics: string[]
      dateStart: string
      dateEnd: string
    }

    interface FilterBarProps {
      onFilterChange: (filters: FilterState) => void
    }

    export function FilterBar({ onFilterChange }: FilterBarProps) {
      const [selectedTopics, setSelectedTopics] = useState<string[]>([])
      const [dateStart, setDateStart] = useState('')
      const [dateEnd, setDateEnd] = useState('')

      function toggleTopic(topic: string) {
        const next = selectedTopics.includes(topic)
          ? selectedTopics.filter(t => t !== topic)
          : [...selectedTopics, topic]
        setSelectedTopics(next)
        onFilterChange({ selectedTopics: next, dateStart, dateEnd })
      }

      function handleDateChange(field: 'start' | 'end', value: string) {
        const next = field === 'start'
          ? { selectedTopics, dateStart: value, dateEnd }
          : { selectedTopics, dateStart, dateEnd: value }
        if (field === 'start') setDateStart(value)
        else setDateEnd(value)
        onFilterChange(next)
      }

      function clearFilters() {
        setSelectedTopics([])
        setDateStart('')
        setDateEnd('')
        onFilterChange({ selectedTopics: [], dateStart: '', dateEnd: '' })
      }

      const hasFilters = selectedTopics.length > 0 || dateStart || dateEnd

      return (
        <div className="bg-white rounded-lg border border-gray-200 p-4 space-y-4">
          <div className="flex items-center justify-between">
            <h3 className="text-sm font-semibold text-gray-700">Filter Sessions</h3>
            {hasFilters && (
              <button
                onClick={clearFilters}
                className="text-xs text-blue-600 hover:underline"
              >
                Clear filters
              </button>
            )}
          </div>

          {/* Date range */}
          <div className="flex gap-3 items-center">
            <div className="flex-1">
              <label className="block text-xs text-gray-500 mb-1">From</label>
              <input
                type="date"
                value={dateStart}
                onChange={e => handleDateChange('start', e.target.value)}
                className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"
              />
            </div>
            <div className="flex-1">
              <label className="block text-xs text-gray-500 mb-1">To</label>
              <input
                type="date"
                value={dateEnd}
                onChange={e => handleDateChange('end', e.target.value)}
                className="w-full border border-gray-300 rounded px-2 py-1.5 text-sm"
              />
            </div>
          </div>

          {/* Topic chips */}
          <div>
            <p className="text-xs text-gray-500 mb-2">Topics</p>
            <div className="flex flex-wrap gap-2">
              {AVAILABLE_TOPICS.map(topic => (
                <button
                  key={topic}
                  onClick={() => toggleTopic(topic)}
                  className={`px-2 py-1 rounded-full text-xs font-medium transition-colors ${
                    selectedTopics.includes(topic)
                      ? 'bg-blue-600 text-white'
                      : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {topic}
                </button>
              ))}
            </div>
          </div>
        </div>
      )
    }
    ```

    **Create src/components/dashboard/SessionHistoryList.tsx:**

    Renders session history as a responsive table/list using the `SessionSummaryRow` type. Uses `date-fns/format` for date display. Uses `getScoreColor` from recommendations.ts for score coloring. Links each row to `/session/:sessionId/summary` (not a separate detail page — Plan 04-03 handles a dedicated detail view; for now link to the summary page already built).

    Actually: Plan 04-03 builds the dedicated detail view `/session/:sessionId/detail`. For now, link session rows to `/session/:sessionId/summary`. Plan 04-03 will add a "View Details" link. So in this component, make each row clickable to navigate to `/session/${row.session_id}/summary`. (Plan 04-03 can add a detail column.)

    ```typescript
    // src/components/dashboard/SessionHistoryList.tsx
    // Paginated session history list. Reads session_summaries rows.
    // DASH-01: shows recent sessions | DASH-02: date/topics/score/duration | DASH-07: filtered via FilterBar
    import { Link } from 'react-router-dom'
    import { format } from 'date-fns'
    import { getScoreColor } from '../../lib/dashboard/recommendations'
    import type { SessionSummaryRow } from '../../types/database'

    interface SessionHistoryListProps {
      sessions: SessionSummaryRow[]
      isLoading: boolean
      page: number
      onNextPage: () => void
      onPrevPage: () => void
      pageSize?: number
    }

    function formatDuration(seconds: number | null): string {
      if (!seconds) return '—'
      const mins = Math.floor(seconds / 60)
      const secs = seconds % 60
      return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`
    }

    export function SessionHistoryList({
      sessions,
      isLoading,
      page,
      onNextPage,
      onPrevPage,
      pageSize = 10
    }: SessionHistoryListProps) {
      if (isLoading) {
        return (
          <div className="space-y-3">
            {Array.from({ length: 3 }).map((_, i) => (
              <div key={i} className="h-16 bg-gray-200 rounded animate-pulse" />
            ))}
          </div>
        )
      }

      if (sessions.length === 0 && page === 0) {
        return (
          <div className="text-center py-12 bg-white rounded-lg border border-gray-200">
            <p className="text-gray-500 text-lg">No sessions yet.</p>
            <p className="text-gray-400 text-sm mt-1">
              Complete a quiz to see your history here.
            </p>
            <Link
              to="/quiz/setup"
              className="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-lg"
            >
              Start a Quiz
            </Link>
          </div>
        )
      }

      return (
        <div className="space-y-3">
          {sessions.map(row => (
            <Link
              key={row.session_id}
              to={`/session/${row.session_id}/summary`}
              className="block bg-white rounded-lg border border-gray-200 px-4 py-3 hover:border-blue-300 hover:shadow-sm transition-all"
            >
              <div className="flex items-center justify-between">
                <div className="min-w-0">
                  <p className="text-sm font-medium text-gray-800 truncate">
                    {row.topics.join(', ')}
                  </p>
                  <p className="text-xs text-gray-400 mt-0.5">
                    {format(new Date(row.created_at), 'MMM d, yyyy · h:mm a')}
                    {' · '}
                    {row.difficulty.charAt(0).toUpperCase() + row.difficulty.slice(1)}
                    {' · '}
                    {formatDuration(row.duration_seconds)}
                  </p>
                </div>
                <div className="ml-4 flex-shrink-0">
                  <span className={`text-2xl font-bold ${getScoreColor(row.final_score)}`}>
                    {row.final_score}
                  </span>
                  <p className="text-xs text-gray-400 text-right">
                    {row.num_completed}✓ {row.num_skipped}↷
                  </p>
                </div>
              </div>
            </Link>
          ))}

          {/* Pagination */}
          <div className="flex justify-between items-center pt-2">
            <button
              onClick={onPrevPage}
              disabled={page === 0}
              className="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed"
            >
              ← Previous
            </button>
            <span className="text-xs text-gray-400">Page {page + 1}</span>
            <button
              onClick={onNextPage}
              disabled={sessions.length < pageSize}
              className="px-3 py-1.5 text-sm border border-gray-300 rounded hover:bg-gray-50 disabled:opacity-40 disabled:cursor-not-allowed"
            >
              Next →
            </button>
          </div>
        </div>
      )
    }
    ```

    **Update src/pages/Dashboard.tsx:**

    Replace the `EmptyState` component with the full dashboard layout: DashboardHeader + FilterBar + SessionHistoryList. Use URL search params for page state (per RESEARCH.md pitfall advice). Use React Query's `QueryClientProvider` — it's already set up in Phase 2 (check if `QueryClientProvider` wraps the app in `main.tsx`; if not, add it there). Import `useSearchParams` from react-router-dom for pagination state.

    ```typescript
    // src/pages/Dashboard.tsx
    import { useState } from 'react'
    import { useSearchParams, Link } from 'react-router-dom'
    import { DashboardHeader } from '../components/dashboard/DashboardHeader'
    import { FilterBar, type FilterState } from '../components/dashboard/FilterBar'
    import { SessionHistoryList } from '../components/dashboard/SessionHistoryList'
    import { useSessions } from '../hooks/useSessions'

    const PAGE_SIZE = 10

    export default function DashboardPage() {
      const [searchParams, setSearchParams] = useSearchParams()
      const page = parseInt(searchParams.get('page') ?? '0', 10)

      const [filters, setFilters] = useState<FilterState>({
        selectedTopics: [],
        dateStart: '',
        dateEnd: ''
      })

      const { data: sessions = [], isLoading } = useSessions({
        page,
        pageSize: PAGE_SIZE,
        topics: filters.selectedTopics.length > 0 ? filters.selectedTopics : undefined,
        dateRange:
          filters.dateStart || filters.dateEnd
            ? { start: filters.dateStart || undefined, end: filters.dateEnd || undefined }
            : undefined
      })

      function handleFilterChange(newFilters: FilterState) {
        setFilters(newFilters)
        // Reset to page 0 when filters change
        setSearchParams({ page: '0' })
      }

      function handleNextPage() {
        setSearchParams({ page: String(page + 1) })
      }

      function handlePrevPage() {
        if (page > 0) setSearchParams({ page: String(page - 1) })
      }

      return (
        <div className="min-h-screen bg-gray-50 flex flex-col">
          <DashboardHeader />
          <main className="flex-1 max-w-3xl mx-auto w-full px-4 py-8 space-y-6">
            <div className="flex items-center justify-between">
              <h1 className="text-xl font-bold text-gray-900">Your Sessions</h1>
              <Link
                to="/quiz/setup"
                className="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-2 rounded-lg transition-colors"
              >
                New Quiz
              </Link>
            </div>

            <FilterBar onFilterChange={handleFilterChange} />

            <SessionHistoryList
              sessions={sessions}
              isLoading={isLoading}
              page={page}
              onNextPage={handleNextPage}
              onPrevPage={handlePrevPage}
              pageSize={PAGE_SIZE}
            />
          </main>
        </div>
      )
    }
    ```

    **Check QueryClientProvider setup:**

    Look in `src/main.tsx`. If `QueryClientProvider` is not yet wrapping the app, add it:
    ```typescript
    import { QueryClient, QueryClientProvider } from '@tanstack/react-query'
    const queryClient = new QueryClient()
    // Wrap <App /> with <QueryClientProvider client={queryClient}>
    ```
    If it's already there from Phase 2 usage, leave it unchanged.
  </action>
  <verify>
    Run: `npx tsc -p tsconfig.app.json --noEmit` — 0 errors.
    Check: `src/lib/dashboard/sessions.ts` exports `getSessionList`.
    Check: `src/hooks/useSessions.ts` imports from `@tanstack/react-query`.
    Check: `src/components/dashboard/FilterBar.tsx` exports `FilterBar` and `FilterState`.
    Check: `src/components/dashboard/SessionHistoryList.tsx` exports `SessionHistoryList`.
    Check: `src/pages/Dashboard.tsx` imports `useSessions` and `SessionHistoryList` (no longer imports `EmptyState`).
    Check: `date-fns` imported in `SessionHistoryList.tsx` with `format` function.
  </verify>
  <done>
    TypeScript compiles clean. Dashboard page renders SessionHistoryList with real data from session_summaries. FilterBar applies topic and date filters. Pagination uses URL search params. Empty state shown when no sessions exist.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc -p tsconfig.app.json --noEmit` → 0 errors
2. `src/lib/dashboard/sessions.ts` queries session_summaries with .range() pagination
3. `src/hooks/useSessions.ts` uses React Query with filter-aware cache key
4. `src/components/dashboard/FilterBar.tsx` renders topic chips and date range inputs
5. `src/components/dashboard/SessionHistoryList.tsx` renders session rows with date/topics/score/duration
6. `src/pages/Dashboard.tsx` composes DashboardHeader + FilterBar + SessionHistoryList
7. Pagination state stored in URL search params (browser back button works)
</verification>

<success_criteria>
- `/dashboard` shows real session history from session_summaries (no more EmptyState placeholder)
- Each session row displays: date, topics, final score (color-coded), duration
- Topic filter chips narrow results; date range inputs filter by date
- Pagination controls work (previous/next pages)
- Filters reset page to 0
- Empty state shown when no sessions or no matching results
- All TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/04-dashboard-analytics/04-02-SUMMARY.md`
</output>
